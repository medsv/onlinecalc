on:
  push:
    - workflows: [deploy-streamlit]
      filter:
        branches: [main]

tokens:
  YC_CONNECTION:
    service_connection: yc-serverless
    scope: org

workflows:
  deploy-streamlit:
    tasks:
      - name: get-iam-token
        cubes:
          - name: get-token
            env:
              ID_TOKEN: ${{ tokens.YC_CONNECTION.id_token }}
              YC_SA_ID: ${{ tokens.YC_CONNECTION.service_account_id }}
            image: cr.yandex/sourcecraft/yc-iam:latest
      - name: deploy-to-serverless
        needs: [get-iam-token]
        cubes:
          - name: deploy
            env:
              YC_FOLDER_ID: ${{ tokens.YC_CONNECTION.folder_id }}
              YC_IAM_TOKEN: ${{ cubes.get-token.outputs.IAM_TOKEN }}
              REGISTRY_ID: crpf3qn8fsblqtbcjnea
              YC_SA_ID: ${{ tokens.YC_CONNECTION.service_account_id }}
            image: cr.yandex/sourcecraft/yc-cli:latest
            script:
              - yc config set folder-id $YC_FOLDER_ID
              - yc config set token $YC_IAM_TOKEN
              - docker build -t cr.yandex/$REGISTRY_ID/streamlit-app:latest .
              - docker push cr.yandex/$REGISTRY_ID/streamlit-app:latest
              - yc serverless container create-revision --container-name streamlit-app --image cr.yandex/$REGISTRY_ID/streamlit-app:latest --cores 1 --memory 1G --execution-timeout 60s --service-account-id $YC_SA_ID --concurrent-requests 1