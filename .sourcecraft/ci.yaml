on:
  push:
    - workflows: [deploy-streamlit]
      filter:
        branches: [main]

workflows:
  deploy-streamlit:
    tasks:
      - name: deploy-to-serverless
        cubes:
          - name: deploy
            env:
              YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
              REGISTRY_ID: crpf3qn8fsblqtbcjnea
            image: cr.yandex/sourcecraft/yc-cli:latest
            script:
              - echo $YC_SERVICE_ACCOUNT_KEY > key.json
              - yc config set service-account-key key.json
              - docker build -t cr.yandex/$REGISTRY_ID/streamlit-app:latest .
              - docker push cr.yandex/$REGISTRY_ID/streamlit-app:latest
              - yc serverless container create-revision --container-name streamlit-app --image cr.yandex/$REGISTRY_ID/streamlit-app:latest --cores 1 --memory 1G --execution-timeout 60s --concurrent-requests 1