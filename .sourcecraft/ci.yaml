on:
  push:
    - workflows: [deploy-streamlit]
      filter:
        branches: [main]

tokens:
  YC_CONNECTION:
    service_connection: yc-serverless
    scope: org

workflows:
  deploy-streamlit:
    tasks:
      - name: get-iam-token
        cubes:
          - name: get-token
            env:
              ID_TOKEN: ${{ tokens.YC_CONNECTION.id_token }}
              YC_SA_ID: ${{ tokens.YC_CONNECTION.service_account_id }}
            image: cr.yandex/sourcecraft/yc-iam:latest
      - name: build-and-deploy
        cubes:
          - name: install-tools
            env:
              YC_FOLDER_ID: ${{ tokens.YC_CONNECTION.folder_id }}
              YC_IAM_TOKEN: ${{ cubes.get-token.outputs.IAM_TOKEN }}
              REGISTRY_ID: crpf3qn8fsblqtbcjnea
            image: docker.io/library/ubuntu:20.04
            script:
              - apt-get update
              - apt-get install -y curl
              - curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
              - apt-get install -y docker.io
          - name: build-and-push-image
            needs: [install-tools]
            env:
              YC_FOLDER_ID: ${{ tokens.YC_CONNECTION.folder_id }}
              YC_IAM_TOKEN: ${{ cubes.get-token.outputs.IAM_TOKEN }}
              REGISTRY_ID: crpf3qn8fsblqtbcjnea
            image: docker.io/library/ubuntu:20.04
            script:
              - yc config set folder-id $YC_FOLDER_ID
              - yc config set token $YC_IAM_TOKEN
              - docker build -t cr.yandex/$REGISTRY_ID/streamlit-app:latest .
              - docker push cr.yandex/$REGISTRY_ID/streamlit-app:latest
          - name: deploy-container
            needs: [build-and-push-image]
            env:
              YC_FOLDER_ID: ${{ tokens.YC_CONNECTION.folder_id }}
              YC_IAM_TOKEN: ${{ cubes.get-token.outputs.IAM_TOKEN }}
              REGISTRY_ID: crpf3qn8fsblqtbcjnea
            image: docker.io/library/ubuntu:20.04
            script:
              - yc config set folder-id $YC_FOLDER_ID
              - yc config set token $YC_IAM_TOKEN
              - yc serverless container create-revision --container-name streamlit-app --image cr.yandex/$REGISTRY_ID/streamlit-app:latest --cores 1 --memory 1G --execution-timeout 60s --service-account-id ${{ tokens.YC_CONNECTION.service_account_id }} --concurrent-requests 1